@model ICollection<TeacherModel>

@{
	ViewData["Title"] = "Gestión de Docentes";
	var layoutName = "_Layout";

	if (User.IsInRole("Student"))
	{
		layoutName = "_LayoutStudent";
	}
	else if (User.IsInRole("Teacher"))
	{
		layoutName = "_LayoutTeacher";
	}
	else if (User.IsInRole("Coordinator"))
	{
		layoutName = "_LayoutCoordinator";
	}

	Layout = $"~/Views/Shared/{layoutName}.cshtml";
}

@Html.AntiForgeryToken()

@section CustomStyles {
	<!-- DataTables CSS -->
	<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
	<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">
	<link rel="stylesheet" href="~/css/coordinator/TeacherManagement/styles.css" asp-append-version="true" />
}

<div class="container-fluid">
	<div class="content-header">
		<div class="container-fluid">
			<div class="row mb-2">
				<div class="col-sm-6">
					<h1>Gestión de Docentes</h1>
				</div>
				<div class="col-sm-6">
					<ol class="breadcrumb float-sm-right">
						<li class="breadcrumb-item">
							@{
								var controllerName = User.IsInRole("Student") ? "Student" :
								User.IsInRole("Teacher") ? "Teacher" :
								User.IsInRole("Coordinator") ? "Coordinator" : "Home";
							}
							<a href="@Url.Action("Index", controllerName)">
								@controllerName
							</a>
						</li>
						<li class="breadcrumb-item active">Gestión de Docentes</li>
					</ol>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Contenido Principal -->
<div class="container-fluid">
	<div class="card">
		<div class="card-header bg-info text-white">
			<h3 class="card-title mb-0">Listado de Docentes</h3>
		</div>

		<div class="card-body">

			<!-- Botón alineado al extremo derecho -->
			<div class="d-flex justify-content-end mb-3">
				<button type="button" class="btn bg-olive" id="createTeacherBtn">
					<i class="fas fa-plus"></i> Crear Docente
				</button>
			</div>
			<div class="search-container mb-3">
				<label for="searchInput">Buscar</label>
				<input type="text" id="searchInput" class="form-control" placeholder="Buscar docentes...">
			</div>

			<table id="teachersTable" class="table table-striped table-hover" style="width:100%">
				<thead>
					<tr>
						<th>NATIONAL_ID</th>
						<th>FULLNAME</th>
						<th>EMAIL</th>
						<th>ACTION</th>
					</tr>
				</thead>
				<tbody>
					@foreach (var teacher in Model)
					{
						<tr>
							<td>@teacher.NationalId</td>
							<td>@teacher.FullName</td>
							<td>@teacher.Email</td>
							<td>
								<button type="button" class="btn btn-sm bg-olive edit-teacher" data-id="@teacher.UserId">
									<i class="fas fa-edit"></i>
								</button>
								<a href="#" class="btn btn-sm btn-danger delete-teacher" data-id="@teacher.UserId">
									<i class="fas fa-trash-alt"></i>
								</a>
							</td>
						</tr>
					}
				</tbody>
			</table>
		</div>
	</div>

	<!-- Contenedores para los modales -->
	<div id="editTeacherModalContainer"></div>
	<div id="createTeacherModalContainer"></div>
</div>

@section Scripts {
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
	<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>

	<script>
		$(document).ready(function () {
			var table = $('#teachersTable').DataTable({
				paging: true,
				ordering: true,
				responsive: true,
				searching: true,
				language: {
					lengthMenu: "Mostrar _MENU_ registros",
					info: "Mostrando _START_ a _END_ de _TOTAL_ docentes",
					paginate: {
						first: "Primero",
						last: "Último",
						next: "Siguiente",
						previous: "Anterior"
					},
					emptyTable: "No hay datos disponibles en la tabla",
					infoEmpty: "Mostrando 0 a 0 de 0 docentes",
					infoFiltered: "(filtrado de _MAX_ registros totales)",
					loadingRecords: "Cargando...",
					processing: "Procesando...",
					zeroRecords: "No se encontraron coincidencias"
				},
				dom: 'lfrtip'
			});

			$('#searchInput').on('keyup', function () {
				table.search(this.value).draw();
			});

			$(document).on("click", ".delete-teacher", function (e) {
				e.preventDefault();
				var $button = $(this);
				var teacherId = $button.data("id");
				var token = $('input[name="__RequestVerificationToken"]').val();

				Swal.fire({
					title: "¿Estás seguro?",
					text: "Esta acción eliminará al docente de forma permanente.",
					icon: "warning",
					showCancelButton: true,
					confirmButtonColor: "#d33",
					cancelButtonColor: "#3085d6",
					confirmButtonText: "Sí, eliminar",
					cancelButtonText: "Cancelar"
				}).then((result) => {
					if (result.isConfirmed) {
						$.post("@Url.Action("TeacherDelete", "Coordinator")", {
							id: teacherId,
							__RequestVerificationToken: token
						}, function () {
							table.row($button.parents('tr')).remove().draw();

							Swal.fire({
								icon: "success",
								title: "Docente eliminado",
								showConfirmButton: false,
								timer: 2000,
								toast: true,
								position: "top-end"
							});
						}).fail(function () {
							Swal.fire({
								icon: "error",
								title: "Error",
								text: "No se pudo eliminar el docente.",
								toast: true,
								position: "top-end",
								showConfirmButton: false,
								timer: 3000
							});
						});
					}
				});
			});


			$(document).on("click", ".edit-teacher", function () {
				var teacherId = $(this).data("id");

				$.get("@Url.Action("TeacherEditModal", "Coordinator")", { id: teacherId }, function (html) {
					$("#editTeacherModalContainer").html(html);
					$("#editTeacherModal").modal("show");
				}).fail(function () {
					alert("Error al cargar el modal de edición.");
				});
			});

			$("#createTeacherBtn").click(function () {
				$.get("@Url.Action("TeacherCreateModal", "Coordinator")", function (html) {
					$("#createTeacherModalContainer").html(html);
					$("#createTeacherModal").modal("show");
				}).fail(function () {
					alert("Error al cargar el modal de creación.");
				});
			});
		});
	</script>

	<script>
		document.addEventListener("DOMContentLoaded", function () {
		@if (TempData["SuccessMessage"] != null)
		{
			<text>
							Swal.fire({
								toast: true,
							position: "top-end",
							title: "¡Éxito!",
							text: decodeURIComponent("@Uri.EscapeDataString(TempData["SuccessMessage"].ToString())"),
							icon: "success",
							showConfirmButton: false,
							timer: 3000,
							timerProgressBar: true
																	});
			</text>
		}

		@if (TempData["ErrorMessage"] != null)
		{
			<text>
							Swal.fire({
								toast: true,
							position: "top-end",
							title: "¡Error!",
							text: decodeURIComponent("@Uri.EscapeDataString(TempData["ErrorMessage"].ToString())"),
							icon: "error",
							showConfirmButton: false,
							timer: 3000,
							timerProgressBar: true
																	});
			</text>
		}
							});
	</script>
}
