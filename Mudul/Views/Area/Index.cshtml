@model IEnumerable<Mudul.EntityModels.Area>

@{
	ViewData["Title"] = "Gestión de Áreas";
	Layout = "_LayoutAdmin";
}

@Html.AntiForgeryToken()

@section CustomStyles {
	<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
	<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">
	<link rel="stylesheet" href="~/css/area/Index/styles.css" asp-append-version="true" />
}

<div class="container-fluid">
	<div class="content-header">
		<div class="container-fluid">
			<div class="row mb-2">
				<div class="col-sm-6">
					<h1>Gestión de Áreas</h1>
				</div>
				<div class="col-sm-6">
					<ol class="breadcrumb float-sm-right">
						<li class="breadcrumb-item"><a href="@Url.Action("Index", "Admin")">Admin</a></li>
						<li class="breadcrumb-item active">Gestión de Áreas</li>
					</ol>
				</div>
			</div>
		</div>
	</div>

	<div class="card">
		<div class="card-header bg-purple text-white">
			<h3 class="card-title mb-0">Listado de Áreas</h3>
		</div>

		<div class="card-body">
			<div class="d-flex justify-content-end mb-3">
				<button type="button" class="btn bg-olive" id="createAreaBtn">
					<i class="fas fa-plus"></i> Nueva Área
				</button>
			</div>

			<div class="search-container mb-3">
				<label for="searchAreaInput">Buscar</label>
				<input type="text" id="searchAreaInput" class="form-control" placeholder="Buscar áreas...">
			</div>

			<table id="areaTable" class="table table-striped table-hover w-100">
				<thead>
					<tr>
						<th>ID</th>
						<th>NOMBRE</th>
						<th>COORDINADOR</th>
						<th>ACCIÓN</th>
					</tr>
				</thead>
				<tbody>
					@foreach (var area in Model)
					{
						<tr>
							<td>@area.AreaId</td>
							<td>@area.Name</td>
							<td>@area.Coordinator.UserName</td>
							<td>
								<button type="button" class="btn btn-sm bg-olive edit-area" data-id="@area.AreaId">
									<i class="fas fa-edit"></i>
								</button>
								<a href="#" class="btn btn-sm btn-danger delete-area" data-id="@area.AreaId">
									<i class="fas fa-trash-alt"></i>
								</a>
							</td>
						</tr>
					}
				</tbody>
			</table>
		</div>
	</div>

	<!-- ViewComponent Modal -->
	<div id="createAreaModalContainer"></div>
	<div id="editAreaModalContainer"></div>
</div>

@section Scripts {
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

	<script>
		$(document).ready(function () {
			let table = $('#areaTable').DataTable({
				responsive: true,
				searching: true,
				language: {
					lengthMenu: "Mostrar _MENU_ registros",
					info: "Mostrando _START_ a _END_ de _TOTAL_ áreas",
					paginate: {
						first: "Primero",
						last: "Último",
						next: "Siguiente",
						previous: "Anterior"
					},
					emptyTable: "No hay datos disponibles",
					infoEmpty: "Mostrando 0 a 0 de 0 registros",
					search: "Buscar:",
					zeroRecords: "No se encontraron coincidencias"
				}
			});

			$('#searchAreaInput').on('keyup', function () {
				table.search(this.value).draw();
			});

			// Eliminar área
			$(document).on("click", ".delete-area", function (e) {
				e.preventDefault();
				let button = $(this);
				let areaId = button.data("id");
				let token = $('input[name="__RequestVerificationToken"]').val();

				Swal.fire({
					title: "¿Eliminar esta área?",
					text: "Esta acción no se puede deshacer.",
					icon: "warning",
					showCancelButton: true,
					confirmButtonColor: "#d33",
					cancelButtonColor: "#3085d6",
					confirmButtonText: "Sí, eliminar",
					cancelButtonText: "Cancelar"
				}).then((result) => {
					if (result.isConfirmed) {
						$.post("@Url.Action("Delete", "Area")", {
							id: areaId,
							__RequestVerificationToken: token
						}, function () {
							table.row(button.parents('tr')).remove().draw();
							Swal.fire({
								icon: "success",
								title: "Área eliminada",
								showConfirmButton: false,
								timer: 2000,
								toast: true,
								position: "top-end"
							});
						}).fail(function () {
							Swal.fire({
								icon: "error",
								title: "Error",
								text: "No se pudo eliminar el área.",
								toast: true,
								position: "top-end",
								showConfirmButton: false,
								timer: 3000
							});
						});
					}
				});
			});

			// Mostrar modal de creación
			$("#createAreaBtn").click(function () {
				$.get("@Url.Action("Create", "Area")", function (html) {
					$("#createAreaModalContainer").html(html);
					$("#createAreaModal").modal("show");
				}).fail(function () {
					alert("Error al cargar el modal de creación.");
				});
			});

			$(document).on("click", ".edit-area", function () {
				var AreaId = $(this).data("id");

				// Carga dinámica del componente de edición
				$.get("@Url.Action("Edit", "Area")", { id: AreaId }, function (html) {
					$("#editAreaModalContainer").html(html);
					$("#editAreaModal").modal("show");
				}).fail(function () {
					alert("Error al cargar el modal de edición.");
				});
			});

		});
	</script>

	<script>
		document.addEventListener("DOMContentLoaded", function () {
		@if (TempData["SuccessMessage"] != null)
		{
			<text>
					Swal.fire({
						toast: true,
						position: "top-end",
						title: "¡Éxito!",
						text: decodeURIComponent("@Uri.EscapeDataString(TempData["SuccessMessage"].ToString())"),
						icon: "success",
						showConfirmButton: false,
						timer: 3000,
						timerProgressBar: true
					});
			</text>
		}

		@if (TempData["ErrorMessage"] != null)
		{
			<text>
					Swal.fire({
						toast: true,
						position: "top-end",
						title: "¡Error!",
						text: decodeURIComponent("@Uri.EscapeDataString(TempData["ErrorMessage"].ToString())"),
						icon: "error",
						showConfirmButton: false,
						timer: 3000,
						timerProgressBar: true
					});
			</text>
		}
		});
	</script>
}
