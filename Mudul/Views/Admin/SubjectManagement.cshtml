@model ICollection<SubjectModel>

@{
	ViewData["Title"] = "Gestión de Clases";
	var layoutName = "_Layout";

	if (User.IsInRole("Teacher"))
	{
		layoutName = "_LayoutTeacher";
	}
	else if (User.IsInRole("Coordinator"))
	{
		layoutName = "_LayoutCoordinator";
	}
	else if (User.IsInRole("Admin"))
	{
		layoutName = "_LayoutAdmin";
	}

	Layout = $"~/Views/Shared/{layoutName}.cshtml";

	// Asignar la clase de rol al body
	string roleClass = "role-student"; // Default role, the student wouldn't see this page but is a default value
	if (User.IsInRole("Teacher"))
	{
		roleClass = "role-teacher";
	}
	else if (User.IsInRole("Coordinator"))
	{
		roleClass = "role-coordinator";
	}
}

@section CustomStyles {
	<!-- DataTables CSS -->
	<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
	<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">
	<link rel="stylesheet" href="~/css/admin/SubjectManagement/styles.css" asp-append-version="true" />
}

<!-- Menu de navegación -->
<div class="content-header">
	<div class="container-fluid">
		<div class="row mb-2">
			<div class="col-sm-6">
				<h1>Matrícula de Estudiante</h1>
			</div>
			<div class="col-sm-6">
				<ol class="breadcrumb float-sm-right">
					<li class="breadcrumb-item">
						@{
							var controllerName = "Home";
							if (User.IsInRole("Teacher"))
							{
								controllerName = "Teacher";
							}
							else if (User.IsInRole("Coordinator"))
							{
								controllerName = "Coordinator";
							}
							else if (User.IsInRole("Admin"))
							{
								controllerName = "Admin";
							}
						}
						<a href="@Url.Action("Index", controllerName)">
							@controllerName
						</a>
					</li>
					<li class="breadcrumb-item">
						Gestión de clases
					</li>
				</ol>
			</div>
		</div>
	</div>
</div>

<!-- Contenido principal -->
<div class="container-fluid">
	<div class="card">
		<div class="card-header bg-gray text-white">
			<h3 class="card-title mb-0">Listado de Clases</h3>
		</div>

		<div class="card-body">

			<!-- Botón alineado al extremo derecho -->
			<div class="d-flex justify-content-end mb-3">
				<button type="button" class="btn bg-olive" id="createSubjectBtn">
					<i class="fas fa-plus"></i> Crear Clase
				</button>
			</div>
			<div class="search-container mb-3">
				<label for="searchInput">Buscar</label>
				<input type="text" id="searchInput" class="form-control" placeholder="Buscar clase...">
			</div>

			<table id="subjectsTable" class="table table-striped table-hover" style="width:100%">
				<thead>
					<tr>
						<th>NOMBRE</th>
						<th>AÑO</th>
						<th>MAESTRO</th>
						<th>AREA</th>
						<th>ACTION</th>
					</tr>
				</thead>
				<tbody>
					@foreach (var subject in Model)
					{
						<tr>
							<td>@subject.Name</td>
							<td>@subject.Year</td>
							<td>@subject.Teacher.UserName</td>
							<td>@subject.Area.Name</td>
							<td>
								<button type="button" class="btn btn-sm bg-olive edit-subject" data-id="@subject.SubjectId">
									<i class="fas fa-edit"></i>
								</button>
								<a href="#" class="btn btn-sm btn-danger delete-subject" data-id="@subject.SubjectId">
									<i class="fas fa-trash-alt"></i>
								</a>
							</td>
						</tr>
					}
				</tbody>
			</table>
		</div>
	</div>


	<!-- Aquí se cargará dinámicamente el modal generado por el ViewComponent -->
	<div id="editSubjectModalContainer"></div>

	<!-- Aquí se cargará dinámicamente el modal para crear docente -->
	<div id="createSubjectModalContainer"></div>
</div>


@section Scripts {
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
	<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>

	<script>
		$(document).ready(function () {
			var table = $('#subjectsTable').DataTable({
				paging: true,
				ordering: true,
				responsive: true,
				searching: true,
				language: {
					lengthMenu: "Mostrar _MENU_ registros",
					info: "Mostrando _START_ a _END_ de _TOTAL_ clases",
					paginate: {
						first: "Primero",
						last: "Último",
						next: "Siguiente",
						previous: "Anterior"
					},
					emptyTable: "No hay datos disponibles en la tabla",
					infoEmpty: "Mostrando 0 a 0 de 0 clases",
					infoFiltered: "(filtrado de _MAX_ registros totales)",
					loadingRecords: "Cargando...",
					processing: "Procesando...",
					zeroRecords: "No se encontraron coincidencias"
				},
				dom: 'lfrtip'
			});

			$('#searchInput').on('keyup', function () {
				table.search(this.value).draw();
			});

			$(document).on("click", ".delete-subject", function (e) {
				e.preventDefault();
				var $button = $(this);
				var subjectId = $button.data("id");
				var token = $('input[name="__RequestVerificationToken"]').val();

				Swal.fire({
					title: "¿Estás seguro?",
					text: "Esta acción eliminará la clase de forma permanente.",
					icon: "warning",
					showCancelButton: true,
					confirmButtonColor: "#d33",
					cancelButtonColor: "#3085d6",
					confirmButtonText: "Sí, eliminar",
					cancelButtonText: "Cancelar"
				}).then((result) => {
					if (result.isConfirmed) {
						$.post("@Url.Action("SubjectDelete", "Admin")", {
							id: subjectId,
							__RequestVerificationToken: token
						}, function () {
							table.row($button.parents('tr')).remove().draw();

							Swal.fire({
								icon: "success",
								title: "Clase eliminada",
								showConfirmButton: false,
								timer: 2000,
								toast: true,
								position: "top-end"
							});
						}).fail(function (xhr) {
							let message = "No se pudo eliminar la clase.";

							// Si el backend envió un mensaje de error personalizado
							if (xhr.responseJSON && xhr.responseJSON.message) {
								message = xhr.responseJSON.message;
							}

							Swal.fire({
								icon: "error",
								title: "Error",
								text: message,
								toast: true,
								position: "top-end",
								showConfirmButton: false,
								timer: 3000
							});
						});
					}
				});
			});


			$(document).on("click", ".edit-subject", function () {
				var subjectId = $(this).data("id");

				// Carga dinámica del componente de edición
				$.get("@Url.Action("SubjectEditModal", "Admin")", { id: subjectId }, function (html) {
					$("#editSubjectModalContainer").html(html);
					const $modal = $("#editSubjectModal");
					$modal.modal("show");

					// Solución al problema de aria-hidden con foco
					$modal.on('shown.bs.modal', function () {
						$modal.find('input:visible:first').trigger('focus');
					});
				}).fail(function () {
					alert("Error al cargar el modal de edición.");
				});
			});

			// Cargar el modal de creación de clase
			$("#createSubjectBtn").click(function () {
				$.get("@Url.Action("SubjectCreateModal", "Admin")", function (html) {
					$("#createSubjectModalContainer").html(html);  // Inyectar el modal en el contenedor
					$("#createSubjectModal").modal("show");  // Mostrar el modal
				}).fail(function () {
					alert("Error al cargar el modal de creación.");
				});
			});

		});
	</script>

	<script>
		document.addEventListener("DOMContentLoaded", function () {
		@if (TempData["SuccessMessage"] != null)
		{
			<text>
									Swal.fire({
										toast: true,
									position: "top-end",
									title: "¡Éxito!",
									text: decodeURIComponent("@Uri.EscapeDataString(TempData["SuccessMessage"].ToString())"),
									icon: "success",
									showConfirmButton: false,
									timer: 3000,
									timerProgressBar: true
															});
			</text>
		}

		@if (TempData["ErrorMessage"] != null)
		{
			<text>
									Swal.fire({
										toast: true,
									position: "top-end",
									title: "¡Error!",
									text: decodeURIComponent("@Uri.EscapeDataString(TempData["ErrorMessage"].ToString())"),
									icon: "error",
									showConfirmButton: false,
									timer: 3000,
									timerProgressBar: true
															});
			</text>
		}
					});
	</script>

	<script>
		// Inicializar CKEditor en los campos con clase .rich-editor
		$(document).ready(function () {
			$('.rich-editor').each(function () {
				ClassicEditor
					.create(this)
					.catch(error => {
						console.error(error);
					});
			});
		});
	</script>
}
