@using Mudul.EntityModels
@model Subject

@{
	ViewData["Title"] = "Editar Clase";
	var layoutName = "_Layout";

	if (User.IsInRole("Teacher"))
	{
		layoutName = "_LayoutTeacher";
	}
	else if (User.IsInRole("Coordinator"))
	{
		layoutName = "_LayoutCoordinator";
	}

	Layout = $"~/Views/Shared/{layoutName}.cshtml";
}

@* Menu de navegacion *@
<div class="content-header">
	<div class="container-fluid">
		<div class="row mb-2">
			<div class="col-sm-6">
				<h1>@Model.Name</h1>
			</div>
			<div class="col-sm-6">
				<ol class="breadcrumb float-sm-right">
					<li class="breadcrumb-item">
						@{
							var controllerName = "Home";
							if (User.IsInRole("Teacher"))
							{
								controllerName = "Teacher";
							}
							else if (User.IsInRole("Coordinator"))
							{
								controllerName = "Coordinator";
							}
						}
						<a href="@Url.Action("Index", controllerName)">
							@controllerName
						</a>
					</li>
					<li class="breadcrumb-item">
						<a href="@Url.Action("Index", "Subject",new{id = Model.SubjectId})">
							@Model.Name
						</a>
					</li>
					<li class="breadcrumb-item">
						<a>
							Edit
						</a>
					</li>
				</ol>
			</div>
		</div>

	</div>
</div>

<section id="tabs-section" class="pt-1 pl-2">
	<div class="nav-tabs-custom">
		<ul class="nav nav-tabs" id="subject-tabs" role="tablist">
			<li class="nav-item">
				<a class="nav-link active" id="general-tab" data-toggle="pill" href="#general" role="tab" aria-controls="general" aria-selected="true">
					General
				</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" id="first-tab" data-toggle="pill" href="#first" role="tab" aria-controls="first" aria-selected="false">
					Primer Parcial
				</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" id="second-tab" data-toggle="pill" href="#second" role="tab" aria-controls="second" aria-selected="false">
					Segundo Parcial
				</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" id="third-tab" data-toggle="pill" href="#third" role="tab" aria-controls="third" aria-selected="false">
					Tercer Parcial
				</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" id="fourth-tab" data-toggle="pill" href="#fourth" role="tab" aria-controls="fourth" aria-selected="false">
					Cuarto Parcial
				</a>
			</li>

			<!-- Gestión de Evaluaciones -->
			<li class="nav-item">
				<a class="nav-link" id="fourth-tab" role="tab" href="@Url.Action("Evaluations","Teacher")">
					Gestor de Exámenes
				</a>
			</li>

			<!-- Modo Edición -->

			<li class="nav-item ml-auto d-flex align-items-center">
				<span class="mr-2">Modo Edición</span>
				<div class="custom-control custom-switch">
					<input type="checkbox" class="custom-control-input" id="editModeSwitch" checked>
					<label class="custom-control-label" for="editModeSwitch"></label>
				</div>
			</li>

		</ul>
	</div>

	<div class="tab-content" id="subject-tabs-content">
		<!-- Sección General -->
		<div class="tab-pane fade show active" id="general" role="tabpanel" aria-labelledby="general-tab">
			<div class="card">
				<div class="card-header d-flex justify-content-between align-items-center">
					<h3 class="card-title mb-0">Descripción General</h3>
					<div class="ml-auto">
						<i class="fa-solid fa-pen-to-square text-primary" style="cursor: pointer;" id="editDescription"></i>
					</div>
				</div>
				<div class="card-body">
					<!-- Mostrar la descripción -->
					<p id="descriptionText">
						@(Model.Description ?? "No hay descripción disponible para esta clase.")
					</p>

					<!-- Formulario oculto para editar -->
					<form id="editForm" method="post" action="@Url.Action("Edit", "Subject", new { id = Model.SubjectId })" class="d-none">
						@Html.AntiForgeryToken()
						<textarea name="description" class="form-control">@Model.Description</textarea>
						<button type="submit" class="btn btn-success btn-sm mt-2">Guardar</button>
					</form>
				</div>
			</div>
		</div>

		<!-- Toast de éxito -->
		<div class="toast position-fixed top-0 end-0 m-3 bg-success text-white" id="successToast" role="alert" aria-live="assertive" aria-atomic="true" style="display: none;">
			<div class="toast-body">
				Descripción guardada exitosamente.
			</div>
		</div>


		<!-- Primer Parcial -->
		<div class="tab-pane fade" id="first" role="tabpanel" aria-labelledby="first-tab">
			<div class="card">
				<div class="card-header d-flex justify-content-between align-items-center">
					<h3 class="card-title mb-0">Primer Parcial - Exámenes y Actividades</h3>
					<div class="ml-auto">
						<i class="fa-solid fa-pen-to-square text-primary" style="cursor: pointer;"></i>
					</div>
				</div>
				<div class="card-body">
					@if (Model.Exams != null && Model.Exams.Any(e => e.ExamType == "P1"))
					{
						<div class="table-responsive">
							<table class="table table-bordered table-hover">
								<thead>
									<tr>
										<th>Título</th>
										<th>Descripción</th>
										<th>Fecha de Publicación</th>
										<th>Tipo</th>
										<th>Acciones</th>
									</tr>
								</thead>
								<tbody>
									@foreach (var exam in Model.Exams.Where(e => e.ExamType == "P1"))
									{
										<tr>
											<td>@exam.Title</td>
											<td>@(exam.Description?.Length > 50 ? exam.Description.Substring(0, 50) + "..." : exam.Description ?? "")</td>
											<td>@(exam.PublishDate?.ToString("dd/MM/yyyy") ?? "No disponible")</td>
											<td>@exam.ExamType</td>
											<td>
												<a href="#" class="btn btn-primary btn-sm">
													<i class="fas fa-eye"></i> Ver
												</a>
											</td>
										</tr>
									}
								</tbody>
							</table>
						</div>
					}
					else
					{
						<div class="alert alert-info">
							No hay exámenes disponibles para el primer parcial.
						</div>
					}
				</div>
			</div>
		</div>

		<!-- Segundo Parcial -->
		<div class="tab-pane fade" id="second" role="tabpanel" aria-labelledby="second-tab">
			<div class="card">
				<div class="card-header d-flex justify-content-between align-items-center">
					<h3 class="card-title mb-0">Segundo Parcial - Exámenes y Actividades</h3>
					<div class="ml-auto">
						<i class="fa-solid fa-pen-to-square text-primary" style="cursor: pointer;"></i>
					</div>
				</div>
				<div class="card-body">
					@if (Model.Exams != null && Model.Exams.Any(e => e.ExamType == "P2"))
					{
						<div class="table-responsive">
							<table class="table table-bordered table-hover">
								<thead>
									<tr>
										<th>Título</th>
										<th>Descripción</th>
										<th>Fecha de Publicación</th>
										<th>Tipo</th>
										<th>Acciones</th>
									</tr>
								</thead>
								<tbody>
									@foreach (var exam in Model.Exams.Where(e => e.ExamType == "P2"))
									{
										<tr>
											<td>@exam.Title</td>
											<td>@(exam.Description?.Length > 50 ? exam.Description.Substring(0, 50) + "..." : exam.Description ?? "")</td>
											<td>@(exam.PublishDate?.ToString("dd/MM/yyyy") ?? "No disponible")</td>
											<td>@exam.ExamType</td>
											<td>
												<a href="#" class="btn btn-primary btn-sm">
													<i class="fas fa-eye"></i> Ver
												</a>
											</td>
										</tr>
									}
								</tbody>
							</table>
						</div>
					}
					else
					{
						<div class="alert alert-info">
							No hay exámenes disponibles para el segundo parcial.
						</div>
					}
				</div>
			</div>
		</div>

		<!-- Tercer Parcial -->
		<div class="tab-pane fade" id="third" role="tabpanel" aria-labelledby="third-tab">
			<div class="card">
				<div class="card-header d-flex justify-content-between align-items-center">
					<h3 class="card-title mb-0">Tercer Parcial - Exámenes y Actividades</h3>
					<div class="ml-auto">
						<i class="fa-solid fa-pen-to-square text-primary" style="cursor: pointer;"></i>
					</div>
				</div>
				<div class="card-body">
					@if (Model.Exams != null && Model.Exams.Any(e => e.ExamType == "P3"))
					{
						<div class="table-responsive">
							<table class="table table-bordered table-hover">
								<thead>
									<tr>
										<th>Título</th>
										<th>Descripción</th>
										<th>Fecha de Publicación</th>
										<th>Tipo</th>
										<th>Acciones</th>
									</tr>
								</thead>
								<tbody>
									@foreach (var exam in Model.Exams.Where(e => e.ExamType == "P3"))
									{
										<tr>
											<td>@exam.Title</td>
											<td>@(exam.Description?.Length > 50 ? exam.Description.Substring(0, 50) + "..." : exam.Description ?? "")</td>
											<td>@(exam.PublishDate?.ToString("dd/MM/yyyy") ?? "No disponible")</td>
											<td>@exam.ExamType</td>
											<td>
												<a href="#" class="btn btn-primary btn-sm">
													<i class="fas fa-eye"></i> Ver
												</a>
											</td>
										</tr>
									}
								</tbody>
							</table>
						</div>
					}
					else
					{
						<div class="alert alert-info">
							No hay exámenes disponibles para el tercer parcial.
						</div>
					}
				</div>
			</div>
		</div>

		<!-- Cuarto Parcial -->
		<div class="tab-pane fade" id="fourth" role="tabpanel" aria-labelledby="fourth-tab">
			<div class="card">
				<div class="card-header d-flex justify-content-between align-items-center">
					<h3 class="card-title mb-0">Cuarto Parcial - Exámenes y Actividades</h3>
					<div class="ml-auto">
						<i class="fa-solid fa-pen-to-square text-primary" style="cursor: pointer;"></i>
					</div>
				</div>
				<div class="card-body">
					@if (Model.Exams != null && Model.Exams.Any(e => e.ExamType == "P4"))
					{
						<div class="table-responsive">
							<table class="table table-bordered table-hover">
								<thead>
									<tr>
										<th>Título</th>
										<th>Descripción</th>
										<th>Fecha de Publicación</th>
										<th>Tipo</th>
										<th>Acciones</th>
									</tr>
								</thead>
								<tbody>
									@foreach (var exam in Model.Exams.Where(e => e.ExamType == "P4"))
									{
										<tr>
											<td>@exam.Title</td>
											<td>@(exam.Description?.Length > 50 ? exam.Description.Substring(0, 50) + "..." : exam.Description ?? "")</td>
											<td>@(exam.PublishDate?.ToString("dd/MM/yyyy") ?? "No disponible")</td>
											<td>@exam.ExamType</td>
											<td>
												<a href="#" class="btn btn-primary btn-sm">
													<i class="fas fa-eye"></i> Ver
												</a>
											</td>
										</tr>
									}
								</tbody>
							</table>
						</div>
					}
					else
					{
						<div class="alert alert-info">
							No hay exámenes disponibles para el cuarto parcial.
						</div>
					}
				</div>
			</div>
		</div>
	</div>

</section>

@section Scripts {
	<script>
		$(function () {
			$('#subject-tabs a').on('click', function (e) {
				e.preventDefault();
				$(this).tab('show');
			});
		});
	</script>

	<script>
		document.getElementById("editModeSwitch").addEventListener("change", function() {
			if (this.checked) {
				// Si se marca, redirigir a la vista de edición
				window.location.href = "@Url.Action("Edit", "Subject", new { id = Model.SubjectId })";
			} else {
				// Si se desmarca, redirigir a la vista normal
				window.location.href = "@Url.Action("Index", "Subject", new { id = Model.SubjectId })";
			}
		});
	</script>

	<script>
		document.addEventListener("DOMContentLoaded", function () {
			const editBtn = document.getElementById("editDescription");
			const descriptionText = document.getElementById("descriptionText");
			const editForm = document.getElementById("editForm");

			let isEditing = false;

			// Alternar entre edición y visualización
			editBtn.addEventListener("click", function () {
				if (!isEditing) {
					descriptionText.classList.add("d-none");
					editForm.classList.remove("d-none");
					editBtn.classList.add("text-danger");
				} else {
					descriptionText.classList.remove("d-none");
					editForm.classList.add("d-none");
					editBtn.classList.remove("text-danger");
				}
				isEditing = !isEditing;
			});

			// Interceptar el envío del formulario
			editForm.addEventListener("submit", function (e) {
				e.preventDefault(); // Evitar el envío normal

				Swal.fire({
					title: "¿Guardar cambios?",
					text: "Se actualizará la descripción de la clase.",
					icon: "warning",
					showCancelButton: true,
					confirmButtonColor: "#3085d6",
					cancelButtonColor: "#d33",
					confirmButtonText: "Sí, guardar",
					cancelButtonText: "Cancelar"
				}).then((result) => {
					if (result.isConfirmed) {
						// Enviar el formulario manualmente
						editForm.submit();
					}
				});
			});
		});
	</script>

	<script>
		document.addEventListener("DOMContentLoaded", function () {
		@if (TempData["ErrorMessage"] != null)
		{
			<text>
								Swal.fire({
									toast: true,
									position: "top-end",
									title: "¡Oh no!",
									text: decodeURIComponent("@Uri.EscapeDataString(TempData["ErrorMessage"].ToString())"),
									icon: "error",
									showConfirmButton: false,
									timer: 3000,
									timerProgressBar: true
								});
			</text>
		}
		});
	</script>
}
